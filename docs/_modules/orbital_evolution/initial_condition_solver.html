

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>orbital_evolution.initial_condition_solver &mdash; (P)lanetary (O)rbital (E)volution due to (T)ides  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/unlimited_width.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> (P)lanetary (O)rbital (E)volution due to (T)ides
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_interface.html">Python Interface</a></li>
<li class="toctree-l1"><a class="reference external" href="https://kpenev.github.io/poet/_static/cpp_doxygen_html/index.html">The C++ interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inclination_eccentricity_equations.html">A detailed derivation of the equations specifying the evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgements.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">(P)lanetary (O)rbital (E)volution due to (T)ides</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>orbital_evolution.initial_condition_solver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for orbital_evolution.initial_condition_solver</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Define class for finding initial conditions to match current properties.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">brentq</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">orbital_evolution.binary</span> <span class="k">import</span> <span class="n">Binary</span>
<span class="kn">from</span> <span class="nn">orbital_evolution.star_interface</span> <span class="k">import</span> <span class="n">EvolvingStar</span>
<span class="kn">from</span> <span class="nn">basic_utils</span> <span class="k">import</span> <span class="n">Structure</span>

<span class="c1">#No good way found to simplify</span>
<span class="c1">#pylint: disable=too-many-instance-attributes</span>
<div class="viewcode-block" id="InitialConditionSolver"><a class="viewcode-back" href="../../_implementation/orbital_evolution.initial_condition_solver.html#orbital_evolution.initial_condition_solver.InitialConditionSolver">[docs]</a><span class="k">class</span> <span class="nc">InitialConditionSolver</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find initial conditions which reproduce a given system now.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="InitialConditionSolver._try_initial_conditions"><a class="viewcode-back" href="../../_implementation/orbital_evolution.initial_condition_solver.html#orbital_evolution.initial_condition_solver.InitialConditionSolver._try_initial_conditions">[docs]</a>    <span class="k">def</span> <span class="nf">_try_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">initial_orbital_period</span><span class="p">,</span>
                                <span class="n">disk_period</span><span class="p">,</span>
                                <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get present orbital and stellar spin periods for initial conditions.</span>

<span class="sd">        Args:</span>
<span class="sd">            initial_orbital_period:    The initial orbital period to calculate</span>
<span class="sd">                the deviation for.</span>

<span class="sd">            disk_period:    The disk locking period to calculate the deviation</span>
<span class="sd">                for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (float, float):</span>
<span class="sd">                The present day orbital period of the system resulting when</span>
<span class="sd">                the evolution is started with the input periods.</span>

<span class="sd">                The present day surface spin of the star resulting when the</span>
<span class="sd">                evolution is started with the input periods.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span><span class="p">(</span>
                <span class="p">(</span><span class="n">initial_orbital_period</span><span class="p">,</span> <span class="n">disk_period</span><span class="p">)</span>
                <span class="ow">in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saved_initial_condition_trials</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_initial_condition_trials</span><span class="p">[</span>
                <span class="p">(</span><span class="n">initial_orbital_period</span><span class="p">,</span> <span class="n">disk_period</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Trying P0 = </span><span class="si">%s</span><span class="s1">, Pdisk = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="nb">repr</span><span class="p">(</span><span class="n">initial_orbital_period</span><span class="p">),</span>
                           <span class="nb">repr</span><span class="p">(</span><span class="n">disk_period</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">Binary</span><span class="p">(</span>
            <span class="n">primary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="p">,</span>
            <span class="n">secondary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span>
            <span class="n">initial_orbital_period</span><span class="o">=</span><span class="n">initial_orbital_period</span><span class="p">,</span>
            <span class="n">initial_eccentricity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;initial eccentricity&#39;</span><span class="p">],</span>
            <span class="n">initial_inclination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;initial inclination&#39;</span><span class="p">],</span>
            <span class="n">disk_lock_frequency</span><span class="o">=</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">disk_period</span><span class="p">,</span>
            <span class="n">disk_dissipation_age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">disk_dissipation_age</span><span class="p">,</span>
            <span class="n">secondary_formation_age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">planet_formation_age</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">select_interpolation_region</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">core_formation_age</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">core_formation_age</span><span class="p">(),</span>
                              <span class="n">semimajor</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span>
                              <span class="n">eccentricity</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span>
                              <span class="n">spin_angmom</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
                              <span class="n">inclination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">periapsis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">evolution_mode</span><span class="o">=</span><span class="s1">&#39;LOCKED_SURFACE_SPIN&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">detect_stellar_wind_saturation</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span> <span class="n">EvolvingStar</span><span class="p">):</span>
            <span class="n">secondary_inclination_periapsis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">inclination</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
                <span class="n">periapsis</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">secondary_inclination_periapsis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">inclination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">periapsis</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
            <span class="n">age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">planet_formation_age</span><span class="p">,</span>
            <span class="n">companion_mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
            <span class="n">semimajor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">semimajor</span><span class="p">(</span><span class="n">initial_orbital_period</span><span class="p">),</span>
            <span class="n">eccentricity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;initial eccentricity&#39;</span><span class="p">],</span>
            <span class="n">spin_angmom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;initial_secondary_angmom&#39;</span><span class="p">],</span>
            <span class="n">locked_surface</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">zero_outer_inclination</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">zero_outer_periapsis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">secondary_inclination_periapsis</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span> <span class="n">EvolvingStar</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">detect_stellar_wind_saturation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span>
            <span class="n">final_age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">age</span><span class="p">,</span>
            <span class="n">max_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;max time step&#39;</span><span class="p">],</span>
            <span class="n">precision</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">],</span>
            <span class="n">required_ages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">print_progress</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">final_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">final_state</span><span class="p">()</span>
        <span class="c1">#False positives</span>
        <span class="c1">#pylint: disable=no-member</span>
        <span class="k">if</span> <span class="n">final_state</span><span class="o">.</span><span class="n">age</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">age</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;System eveloution failed at age </span><span class="si">{0!r}</span><span class="s1">, targe age </span><span class="si">{1!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">final_state</span><span class="o">.</span><span class="n">age</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">age</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">orbital_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">orbital_period</span><span class="p">(</span><span class="n">final_state</span><span class="o">.</span><span class="n">semimajor</span><span class="p">)</span>
        <span class="n">stellar_spin_period</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span>
            <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">envelope_inertia</span><span class="p">(</span><span class="n">final_state</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
            <span class="o">/</span>
            <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">final_state</span><span class="p">,</span> <span class="s1">&#39;primary_envelope_angmom&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="ow">or</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">final_state</span><span class="p">,</span> <span class="s1">&#39;envelope_angmom&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1">#pylint: enable=no-member</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Got Porb = </span><span class="si">%s</span><span class="s1">, P* = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="nb">repr</span><span class="p">(</span><span class="n">orbital_period</span><span class="p">),</span>
                           <span class="nb">repr</span><span class="p">(</span><span class="n">stellar_spin_period</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">orbital_period</span><span class="p">):</span>
            <span class="n">orbital_period</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_initial_condition_trials</span><span class="p">[</span>
                <span class="p">(</span><span class="n">initial_orbital_period</span><span class="p">,</span> <span class="n">disk_period</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">orbital_period</span><span class="p">,</span> <span class="n">stellar_spin_period</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orbital_period</span><span class="p">,</span> <span class="n">stellar_spin_period</span></div>

<div class="viewcode-block" id="InitialConditionSolver._find_porb_range"><a class="viewcode-back" href="../../_implementation/orbital_evolution.initial_condition_solver.html#orbital_evolution.initial_condition_solver.InitialConditionSolver._find_porb_range">[docs]</a>    <span class="k">def</span> <span class="nf">_find_porb_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">guess_porb_initial</span><span class="p">,</span>
                         <span class="n">disk_period</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find initial orbital period range where final porb error flips sign.</span>

<span class="sd">        Args:</span>
<span class="sd">            guess_porb_initial:    An initial guess for where the sign change</span>
<span class="sd">                occurs.</span>

<span class="sd">            disk_period:    The disk locking period to assume during the search.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (float, float):</span>
<span class="sd">                A pair of initial orbital periods for which the sign of the</span>
<span class="sd">                final orbital period error changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">porb_min</span><span class="p">,</span> <span class="n">porb_max</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">porb_initial</span> <span class="o">=</span> <span class="n">guess_porb_initial</span>
        <span class="n">porb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_initial_conditions</span><span class="p">(</span><span class="n">porb_initial</span><span class="p">,</span> <span class="n">disk_period</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">porb_error</span> <span class="o">=</span> <span class="n">porb</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">Porb</span>
        <span class="n">guess_porb_error</span> <span class="o">=</span> <span class="n">porb_error</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period_search_factor</span> <span class="k">if</span> <span class="n">guess_porb_error</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_search_factor</span><span class="p">)</span>

        <span class="k">while</span> <span class="p">(</span>
                <span class="n">porb_error</span> <span class="o">*</span> <span class="n">guess_porb_error</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="ow">and</span>
                <span class="n">porb_initial</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_porb_initial</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">porb_error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">porb_min</span> <span class="o">=</span> <span class="n">porb_initial</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">porb_max</span> <span class="o">=</span> <span class="n">porb_initial</span>
            <span class="n">porb_initial</span> <span class="o">*=</span> <span class="n">step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;Before evolution:&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">porb_error = </span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">guess_porb_error = </span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">porb_initial = </span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">porb_min = </span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">porb_max = </span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">step = </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">porb_error</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">guess_porb_error</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">porb_initial</span><span class="p">),</span>
                <span class="n">porb_min</span><span class="p">,</span>
                <span class="n">porb_max</span><span class="p">,</span>
                <span class="n">step</span>
            <span class="p">)</span>
            <span class="n">porb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_initial_conditions</span><span class="p">(</span><span class="n">porb_initial</span><span class="p">,</span>
                                                <span class="n">disk_period</span><span class="p">,</span>
                                                <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;After evolution: porb = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">porb</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scipy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">porb</span><span class="p">):</span>
                <span class="n">porb_error</span> <span class="o">=</span> <span class="n">porb</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">Porb</span>

        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">porb_error</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">porb_error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">porb_min</span> <span class="o">=</span> <span class="n">porb_initial</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">porb_max</span> <span class="o">=</span> <span class="n">porb_initial</span>
            <span class="k">if</span> <span class="n">porb_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">porb_min</span> <span class="o">=</span> <span class="n">porb_initial</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;For Pdisk = </span><span class="si">%s</span><span class="s1">, orbital period range: </span><span class="si">%s</span><span class="s1"> &lt; Porb &lt; </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">disk_period</span><span class="p">),</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">porb_min</span><span class="p">),</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">porb_max</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">porb_min</span><span class="p">,</span> <span class="n">porb_max</span></div>

<div class="viewcode-block" id="InitialConditionSolver.__init__"><a class="viewcode-back" href="../../_implementation/orbital_evolution.initial_condition_solver.html#orbital_evolution.initial_condition_solver.InitialConditionSolver.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">planet_formation_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">disk_dissipation_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">evolution_max_time_step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">evolution_precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                 <span class="n">evolution_timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">orbital_period_tolerance</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                 <span class="n">spin_tolerance</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                 <span class="n">initial_eccentricity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">initial_inclination</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">period_search_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                 <span class="n">scaled_period_guess</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">max_porb_initial</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
                 <span class="n">initial_secondary_angmom</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object.</span>

<span class="sd">        Args:</span>
<span class="sd">            planet_formation_age:    If not None, the planet is assumed to form</span>
<span class="sd">                at the given age (in Gyr). Otherwise, the starting age must be</span>
<span class="sd">                specified each time this object is called.</span>

<span class="sd">            disk_dissipation_age:    The age at which the disk dissipates in</span>
<span class="sd">                Gyrs.</span>

<span class="sd">            evolution_max_time_step:    The maximum timestep the evolution is</span>
<span class="sd">                allowed to make.</span>

<span class="sd">            evolution_precision:    The precision to require of the evolution.</span>

<span class="sd">            orbital_period_tolerance:    The required precision with which the</span>
<span class="sd">                orbital period at the present age must be reproduced.</span>

<span class="sd">            spin_tolerance:    The required precision with which the</span>
<span class="sd">                primary spin period at the present age must be reproduced.</span>

<span class="sd">            initial_eccentricity:    The initial eccentricity with which to</span>
<span class="sd">                start the evolution.</span>

<span class="sd">            period_search_factor:    The factor by which to change the initial</span>
<span class="sd">                period guess while searching for a range surrounding the known</span>
<span class="sd">                present day orbital period.</span>

<span class="sd">            scaled_period_guess:    The search for initial period to bracked the</span>
<span class="sd">                observed final period will start from this value multiplied by</span>
<span class="sd">                the final orbital period.</span>

<span class="sd">            max_porb_initial:    The largest initial orbital period in days to</span>
<span class="sd">                try before declaring a set of initial conditions unsolvable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;initial eccentricity&#39;</span><span class="p">:</span> <span class="n">initial_eccentricity</span><span class="p">,</span>
            <span class="s1">&#39;initial inclination&#39;</span><span class="p">:</span> <span class="n">initial_inclination</span><span class="p">,</span>
            <span class="s1">&#39;initial_secondary_angmom&#39;</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initial_secondary_angmom</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">planet_formation_age</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;planet formation age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">planet_formation_age</span>
        <span class="k">if</span> <span class="n">disk_dissipation_age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;disk dissipation age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk_dissipation_age</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max time step&#39;</span><span class="p">:</span> <span class="n">evolution_max_time_step</span><span class="p">,</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">evolution_precision</span><span class="p">,</span>
            <span class="s1">&#39;orbital period tolerance&#39;</span><span class="p">:</span> <span class="n">orbital_period_tolerance</span><span class="p">,</span>
            <span class="s1">&#39;spin tolerance&#39;</span><span class="p">:</span> <span class="n">spin_tolerance</span><span class="p">,</span>
            <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">evolution_timeout</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period_search_factor</span> <span class="o">=</span> <span class="n">period_search_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaled_period_guess</span> <span class="o">=</span> <span class="n">scaled_period_guess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_porb_initial</span> <span class="o">=</span> <span class="n">max_porb_initial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_initial_condition_trials</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="InitialConditionSolver.stellar_wsurf"><a class="viewcode-back" href="../../_implementation/orbital_evolution.initial_condition_solver.html#orbital_evolution.initial_condition_solver.InitialConditionSolver.stellar_wsurf">[docs]</a>    <span class="k">def</span> <span class="nf">stellar_wsurf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">wdisk</span><span class="p">,</span>
                      <span class="n">orbital_period_guess</span><span class="p">,</span>
                      <span class="n">return_difference</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The stellar spin frquency when reproducing current porb.</span>

<span class="sd">        Args:</span>
<span class="sd">            disk_frequency:    The angular velocity of the star when it forms.</span>

<span class="sd">            orbital_period_guess:    A best guess value for the initial orbital</span>
<span class="sd">                period.</span>

<span class="sd">            return_difference:    If True, instead of the actual stellar</span>
<span class="sd">                angular velocity, the function returns the difference from the</span>
<span class="sd">                observed value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or (float, float, float):</span>

<span class="sd">                * The angular velocity with which the star spins at the present</span>
<span class="sd">                  age for an evolution scenario which reproduces the current</span>
<span class="sd">                  orbital period. Or the difference between the spin frequency</span>
<span class="sd">                  and the target spin frequency if return_difference is True.</span>

<span class="sd">                The following are returned only if return_difference is False:</span>

<span class="sd">                    * The initial orbital period which reproduces the specified</span>
<span class="sd">                      final orbital period as close as possible.</span>

<span class="sd">                    * The closest final orbital period found (starting with</span>
<span class="sd">                      porb_initial).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">disk_period</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wdisk</span>

        <span class="n">porb_min</span><span class="p">,</span> <span class="n">porb_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_porb_range</span><span class="p">(</span><span class="n">orbital_period_guess</span><span class="p">,</span>
                                                   <span class="n">disk_period</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">porb_min</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_initial_condition_trials</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">scipy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">porb_max</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">return_difference</span> <span class="k">else</span> <span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                                         <span class="n">scipy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                                         <span class="n">scipy</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
        <span class="n">porb_initial</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">porb_initial</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_initial_conditions</span><span class="p">(</span>
                <span class="n">porb_initial</span><span class="p">,</span>
                <span class="n">disk_period</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">Porb</span><span class="p">,</span>
            <span class="n">porb_min</span><span class="p">,</span>
            <span class="n">porb_max</span><span class="p">,</span>
            <span class="n">xtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;orbital period tolerance&#39;</span><span class="p">],</span>
            <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;orbital period tolerance&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">porb_final</span><span class="p">,</span> <span class="n">spin_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_initial_conditions</span><span class="p">(</span>
            <span class="n">porb_initial</span><span class="p">,</span>
            <span class="n">disk_period</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_initial_condition_trials</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">spin_frequency</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">spin_period</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_difference</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spin_frequency</span><span class="p">,</span> <span class="n">porb_initial</span><span class="p">,</span> <span class="n">porb_final</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">spin_frequency</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">Psurf</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="o">&lt;</span>
                <span class="c1">#False positive</span>
                <span class="c1">#pylint: disable=no-member</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span><span class="o">.</span><span class="n">spin_frequency</span>
                    <span class="o">-</span>
                    <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">Psurf</span><span class="p">)</span>
                <span class="c1">#pylint: enable=no-member</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span><span class="o">.</span><span class="n">spin_frequency</span> <span class="o">=</span> <span class="n">spin_frequency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span><span class="o">.</span><span class="n">orbital_period</span> <span class="o">=</span> <span class="n">porb_final</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span><span class="o">.</span><span class="n">initial_orbital_period</span> <span class="o">=</span> <span class="n">porb_initial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span><span class="o">.</span><span class="n">disk_period</span> <span class="o">=</span> <span class="n">disk_period</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="InitialConditionSolver.__call__"><a class="viewcode-back" href="../../_implementation/orbital_evolution.initial_condition_solver.html#orbital_evolution.initial_condition_solver.InitialConditionSolver.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">planet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find initial conditions which reproduce the given system now.</span>

<span class="sd">        Args:</span>
<span class="sd">            target:    The target configuration to reproduce by tuning the the</span>
<span class="sd">                initial conditions for. The following attributes must be</span>
<span class="sd">                defined:</span>

<span class="sd">                    - age:</span>
<span class="sd">                        The age at which the system configuration is known.</span>

<span class="sd">                    - Porb:</span>
<span class="sd">                        The orbital period to reproduce.</span>

<span class="sd">                    - Psurf | Pdisk | Wdisk:</span>
<span class="sd">                        The stellar surface spin period to reproduce or the</span>
<span class="sd">                        disk locking period or the disk locking frequency.</span>

<span class="sd">                The following optional attributes can be specified:</span>

<span class="sd">                    - planet_formation_age:</span>
<span class="sd">                        The age at which the planet forms in Gyrs. If not</span>
<span class="sd">                        specified the planet is assumed to form either</span>
<span class="sd">                        &#39;-past_lifetime&#39; Gyrs before &#39;-age&#39; or as soon as</span>
<span class="sd">                        the disk dissipates.</span>

<span class="sd">                    - past_lifetime:</span>
<span class="sd">                        An alternative way of specifying when the planet</span>
<span class="sd">                        forms. If the &#39;-planet_formation-age&#39; attribute is</span>
<span class="sd">                        not defined, the planet is assumed to form this many</span>
<span class="sd">                        Gyr before &#39;-age&#39;.</span>

<span class="sd">                    - disk_dissipation_age:</span>
<span class="sd">                        The age at which the disk dissipates in Gyrs. If not</span>
<span class="sd">                        specified, it must have been defined when this solver</span>
<span class="sd">                        was initialized.</span>
<span class="sd">            star:    The star to use in the evolution, should be instance of</span>
<span class="sd">                evolve_interface.EvolvingStar and its dissipative properties</span>
<span class="sd">                should be defined.</span>

<span class="sd">            planet:    The planet to use in the evolution. Should be an instance</span>
<span class="sd">                of evolve_interface.LockedPlanet</span>

<span class="sd">        Returns:</span>
<span class="sd">            (float, float):</span>
<span class="sd">                * Initial orbital period.</span>

<span class="sd">                * Initial disk period if matching observed stellar spin or</span>
<span class="sd">                  stellar spin if initial disk period is specified.</span>

<span class="sd">            Further, the solver object has an attribute named &#39;binary&#39; (an</span>
<span class="sd">            instance of (evolve_interface.Binary) which was evolved from</span>
<span class="sd">            the initial conditions found to most closely reproduce the</span>
<span class="sd">            specified target configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">reset_best_initial_conditions</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Reset the entries in self._best_initial_conditions.&quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span>
                <span class="n">spin_frequency</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                <span class="n">orbital_period</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="n">initial_orbital_period</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="n">disk_period</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_initial_grid</span><span class="p">(</span><span class="n">orbital_period_guess</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Tabulate stellar spin errors for a grid of disk periods.&quot;&quot;&quot;</span>

            <span class="n">reset_best_initial_conditions</span><span class="p">()</span>

            <span class="n">wdisk_grid</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">200.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">20.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">0.02</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="o">-</span><span class="mf">0.002</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="mf">0.002</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="mf">0.02</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="mf">0.2</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="mf">20.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="mf">200.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span><span class="p">]</span>

            <span class="n">stellar_wsurf_residual_grid</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stellar_wsurf</span><span class="p">(</span><span class="n">wdisk</span><span class="p">,</span> <span class="n">orbital_period_guess</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">wdisk</span> <span class="ow">in</span> <span class="n">wdisk_grid</span>
            <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;##    </span><span class="si">%25s</span><span class="s1"> </span><span class="si">%25s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;disk_period&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;current_stellar_spin&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">wdisk</span><span class="p">,</span> <span class="n">wsurf_residual</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wdisk_grid</span><span class="p">,</span>
                                             <span class="n">stellar_wsurf_residual_grid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;##    </span><span class="si">%25.16e</span><span class="s1"> </span><span class="si">%25.16e</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wdisk</span><span class="p">,</span>
                    <span class="n">wsurf_residual</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">Psurf</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;## Target current stellar spin: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">Psurf</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">wdisk_grid</span><span class="p">,</span> <span class="n">stellar_wsurf_residual_grid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span> <span class="o">=</span> <span class="n">star</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="o">=</span> <span class="n">planet</span>
        <span class="n">orbital_period_guess</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">Porb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaled_period_guess</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;disk_dissipation_age&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">disk_dissipation_age</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;disk dissipation age&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;planet_formation_age&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;past_lifetime&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">planet_formation_age</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">age</span>
                                                    <span class="o">-</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">past_lifetime</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">planet_formation_age</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;planet formation age&#39;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;Psurf&#39;</span><span class="p">):</span>
            <span class="n">wdisk</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">Wdisk</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;Wdisk&#39;</span><span class="p">)</span>
                     <span class="k">else</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">target</span><span class="o">.</span><span class="n">Pdisk</span><span class="p">)</span>
            <span class="n">wstar</span><span class="p">,</span> <span class="n">porb_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stellar_wsurf</span><span class="p">(</span><span class="n">wdisk</span><span class="p">,</span>
                                                     <span class="n">orbital_period_guess</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">porb_initial</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wstar</span>

        <span class="n">wdisk_grid</span><span class="p">,</span> <span class="n">stellar_wsurf_residual_grid</span> <span class="o">=</span> <span class="n">get_initial_grid</span><span class="p">(</span>
            <span class="n">orbital_period_guess</span>
        <span class="p">)</span>

        <span class="n">nsolutions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wdisk_grid</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="n">stellar_wsurf_residual_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="o">*</span>
                    <span class="n">stellar_wsurf_residual_grid</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">&lt;</span>
                    <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">wdisk</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stellar_wsurf</span><span class="p">,</span>
                    <span class="n">a</span><span class="o">=</span><span class="n">wdisk_grid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">b</span><span class="o">=</span><span class="n">wdisk_grid</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">orbital_period_guess</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="n">xtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;spin tolerance&#39;</span><span class="p">],</span>
                    <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;spin tolerance&#39;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">nsolutions</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#False positive</span>
            <span class="c1">#pylint: disable=no-member</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span><span class="o">.</span><span class="n">initial_orbital_period</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_best_initial_conditions</span><span class="o">.</span><span class="n">disk_period</span><span class="p">)</span></div></div>
            <span class="c1">#pylint: enable=no-member</span>
<span class="c1">#pylint: enable=too-many-instance-attributes</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Kaloyan Penev

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>